name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_COMPOSE_FILE: docker/docker-compose.yml
  REMOTE_PROJECT_PATH: /opt/frappe-hrms

jobs:
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-2' }}

      - name: Verify AWS CLI
        run: |
          # AWS CLI is pre-installed on GitHub Actions runners
          # For act-cli, install if needed (cached after first run)
          if ! command -v aws &> /dev/null; then
            echo "AWS CLI not found, installing..."
            curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
            echo "âœ“ AWS CLI installed"
          else
            echo "âœ“ AWS CLI already available"
          fi
          aws --version

      - name: Retrieve deployment secrets from AWS Secrets Manager
        id: secrets
        run: |
          # Determine the region for the secret (can be different from default region)
          SECRET_REGION="${{ secrets.AWS_SECRETS_REGION || secrets.AWS_REGION || 'eu-west-2' }}"
          
          echo "Fetching secret from region: $SECRET_REGION"
          
          # Retrieve the secret value
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "${{ secrets.AWS_DEPLOY_SECRET_ID }}" \
            --region "$SECRET_REGION" \
            --query SecretString \
            --output text)
          
          # Export for prepare_context.py
          echo "SECRET_JSON<<EOF" >> $GITHUB_ENV
          echo "$SECRET_JSON" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare deployment context
        id: prepare
        run: |
          python deploy/lightsail/prepare_context.py

      - name: Verify SSH key and setup
        run: |
          chmod 600 ${{ steps.prepare.outputs.ssh_key_path }}
          ssh-keyscan -p ${{ steps.prepare.outputs.port }} -H ${{ steps.prepare.outputs.host }} >> ~/.ssh/known_hosts || true

      - name: Create deployment package
        run: |
          # Create a tarball of the repository excluding unnecessary files
          tar -czf deploy-package.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='coverage' \
            --exclude='*.log' \
            --exclude='deploy-package.tar.gz' \
            .

      - name: Copy deployment package to Lightsail
        run: |
          scp -P ${{ steps.prepare.outputs.port }} \
            -i ${{ steps.prepare.outputs.ssh_key_path }} \
            -o StrictHostKeyChecking=no \
            deploy-package.tar.gz \
            ${{ steps.prepare.outputs.user }}@${{ steps.prepare.outputs.host }}:/tmp/

      - name: Deploy on Lightsail instance
        run: |
          ssh -p ${{ steps.prepare.outputs.port }} \
            -i ${{ steps.prepare.outputs.ssh_key_path }} \
            -o StrictHostKeyChecking=no \
            ${{ steps.prepare.outputs.user }}@${{ steps.prepare.outputs.host }} << 'ENDSSH'
          
          set -e
          
          echo "=== Starting deployment ==="
          
          # Create project directory if it doesn't exist
          sudo mkdir -p ${{ steps.prepare.outputs.remote_path }}
          sudo chown ${{ steps.prepare.outputs.user }}:${{ steps.prepare.outputs.user }} ${{ steps.prepare.outputs.remote_path }}
          
          # Extract deployment package
          cd ${{ steps.prepare.outputs.remote_path }}
          tar -xzf /tmp/deploy-package.tar.gz
          rm /tmp/deploy-package.tar.gz
          
          echo "=== Files extracted successfully ==="
          
          # Check if .env.remote exists, if not create a default one
          if [ ! -f "${{ steps.prepare.outputs.env_file }}" ]; then
            echo "Warning: .env.remote not found, creating default"
            mkdir -p deploy/lightsail
            touch deploy/lightsail/.env.remote
          fi
          
          # Stop existing containers
          echo "=== Stopping existing containers ==="
          if [ -f "${{ steps.prepare.outputs.compose_file }}" ]; then
            sudo docker compose -f ${{ steps.prepare.outputs.compose_file }} --env-file ${{ steps.prepare.outputs.env_file }} down || true
          fi
          
          # Pull latest images and rebuild
          echo "=== Building and starting containers ==="
          sudo docker compose -f ${{ steps.prepare.outputs.compose_file }} --env-file ${{ steps.prepare.outputs.env_file }} pull || true
          sudo docker compose -f ${{ steps.prepare.outputs.compose_file }} --env-file ${{ steps.prepare.outputs.env_file }} up -d --build
          
          echo "=== Waiting for services to be ready ==="
          sleep 10
          
          # Check container status
          echo "=== Container status ==="
          sudo docker compose -f ${{ steps.prepare.outputs.compose_file }} ps
          
          # Setup nginx reverse proxy
          echo "=== Configuring nginx ==="
          sudo tee /etc/nginx/sites-available/frappe-hrms > /dev/null << 'NGINXCONF'
          upstream frappe-server {
              server 127.0.0.1:8000 fail_timeout=0;
          }

          upstream socketio-server {
              server 127.0.0.1:9000 fail_timeout=0;
          }

          server {
              listen 80;
              server_name _;

              client_max_body_size 50m;
              client_body_buffer_size 16k;

              location / {
                  proxy_pass http://frappe-server;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 300;
                  proxy_connect_timeout 300;
              }

              location /socket.io {
                  proxy_pass http://socketio-server;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /assets {
                  proxy_pass http://frappe-server;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /files {
                  proxy_pass http://frappe-server;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINXCONF
          
          # Enable the site
          sudo ln -sf /etc/nginx/sites-available/frappe-hrms /etc/nginx/sites-enabled/frappe-hrms
          
          # Remove default nginx site if it exists
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Test nginx configuration
          sudo nginx -t
          
          # Reload nginx
          sudo systemctl reload nginx
          
          echo "=== Nginx configured and reloaded ==="
          
          # Clean up old Docker images
          echo "=== Cleaning up old Docker images ==="
          sudo docker system prune -f
          
          echo "=== Deployment completed successfully ==="
          echo "=== Frappe HRMS should be accessible at http://${{ steps.prepare.outputs.host }} ==="
          ENDSSH

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Access your application at: http://${{ steps.prepare.outputs.host }}"
          echo "ðŸ“¦ Deployed to: ${{ steps.prepare.outputs.remote_path }}"

