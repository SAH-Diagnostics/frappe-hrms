name: Build and Deploy to Lightsail

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate AWS Secrets
        run: |
          MISSING_SECRETS=()
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            MISSING_SECRETS+=("AWS_ACCESS_KEY_ID")
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            MISSING_SECRETS+=("AWS_SECRET_ACCESS_KEY")
          fi
          if [ -z "${{ secrets.AWS_DEPLOY_SECRET_ID }}" ]; then
            MISSING_SECRETS+=("AWS_DEPLOY_SECRET_ID")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::The following GitHub Secrets are missing: ${MISSING_SECRETS[*]}"
            echo ""
            echo "Please add these secrets in your GitHub repository:"
            echo "1. Go to: Settings > Secrets and variables > Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Add each of the following:"
            echo "   - AWS_ACCESS_KEY_ID: Your AWS access key ID"
            echo "   - AWS_SECRET_ACCESS_KEY: Your AWS secret access key"
            echo "   - AWS_DEPLOY_SECRET_ID: The ARN of your AWS Secrets Manager secret (e.g., arn:aws:secretsmanager:eu-north-1:280648354859:secret:prod/frappe-Aojmb0)"
            echo "   - AWS_REGION (optional): AWS region for operations (defaults to eu-west-2)"
            echo "   - AWS_SECRETS_REGION (optional): Region where the secret is stored (defaults to AWS_REGION or eu-west-2)"
            echo ""
            echo "Note: These credentials are needed to authenticate to AWS and retrieve the deployment secrets from AWS Secrets Manager."
            exit 1
          fi
          echo "✓ All required AWS secrets are configured"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-2' }} 

      - name: Retrieve Secrets from AWS Secrets Manager
        id: get-secrets
        env:
          SECRET_ARN: ${{ secrets.AWS_DEPLOY_SECRET_ID }}
          SECRETS_REGION: ${{ secrets.AWS_SECRETS_REGION || secrets.AWS_REGION || 'eu-west-2' }}
        run: |
          echo "Retrieving secret from AWS Secrets Manager..."
          echo "Secret ARN: $SECRET_ARN"
          echo "Region: $SECRETS_REGION"
          
          # Extract region from ARN if it's a full ARN (format: arn:aws:secretsmanager:REGION:ACCOUNT:secret:NAME)
          if [[ "$SECRET_ARN" == arn:aws:secretsmanager:* ]]; then
            ARN_REGION=$(echo "$SECRET_ARN" | cut -d: -f4)
            if [ -n "$ARN_REGION" ]; then
              echo "Using region from ARN: $ARN_REGION"
              SECRETS_REGION="$ARN_REGION"
            fi
          fi
          
          # Get secret value - AWS Secrets Manager returns key-value pairs as JSON
          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "$SECRET_ARN" \
            --region "$SECRETS_REGION" \
            --query SecretString \
            --output text)
          
          if [ -z "$SECRET_VALUE" ]; then
            echo "::error::Failed to retrieve secret from AWS Secrets Manager"
            exit 1
          fi
          
          echo "✓ Successfully retrieved secret from AWS Secrets Manager"
          echo "SECRET_JSON<<EOF" >> $GITHUB_ENV
          echo "$SECRET_VALUE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare Deployment Context
        id: context
        env:
          SECRET_JSON: ${{ env.SECRET_JSON }}
        run: |
          python3 deploy/lightsail/prepare_context.py
          # The prepare_context.py script writes outputs to GITHUB_OUTPUT
          # These will be available as step outputs automatically

      - name: Create Deployment Package
        run: |
          # Create a tarball excluding unnecessary files
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.github' \
              --exclude='*.pyc' \
              --exclude='__pycache__' \
              --exclude='.env*' \
              -czf deploy-package.tar.gz .

      - name: Copy Files to Lightsail
        env:
          SSH_KEY: ${{ steps.context.outputs.ssh_key_path }}
          LIGHTSAIL_HOST: ${{ steps.context.outputs.host }}
          LIGHTSAIL_USER: ${{ steps.context.outputs.user }}
          LIGHTSAIL_PORT: ${{ steps.context.outputs.port }}
        run: |
          # Set SSH key permissions
          chmod 600 "$SSH_KEY"
          
          # Copy package to Lightsail
          scp -i "$SSH_KEY" \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -P "${LIGHTSAIL_PORT:-22}" \
              deploy-package.tar.gz \
              "$LIGHTSAIL_USER@$LIGHTSAIL_HOST:/tmp/"

      - name: Deploy on Lightsail
        env:
          SSH_KEY: ${{ steps.context.outputs.ssh_key_path }}
          LIGHTSAIL_HOST: ${{ steps.context.outputs.host }}
          LIGHTSAIL_USER: ${{ steps.context.outputs.user }}
          LIGHTSAIL_PORT: ${{ steps.context.outputs.port }}
          REMOTE_PATH: ${{ steps.context.outputs.remote_path }}
        run: |
          ssh -i "$SSH_KEY" \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -p "${LIGHTSAIL_PORT:-22}" \
              "$LIGHTSAIL_USER@$LIGHTSAIL_HOST" << 'ENDSSH'
            set -e
            
            # Create remote directory if it doesn't exist
            sudo mkdir -p "${{ steps.context.outputs.remote_path }}"
            sudo chown -R $USER:$USER "${{ steps.context.outputs.remote_path }}"
            
            # Extract package
            cd "${{ steps.context.outputs.remote_path }}"
            tar -xzf /tmp/deploy-package.tar.gz
            rm /tmp/deploy-package.tar.gz
            
            # Copy env file to docker directory for docker-compose to use
            if [ -f "deploy/lightsail/.env.remote" ]; then
              cp deploy/lightsail/.env.remote docker/.env
            fi
            
            # Stop existing containers
            cd docker
            docker compose down || true
            
            # Build and start containers (docker-compose will automatically use .env file)
            docker compose --env-file .env up -d --build
            
            # Clean up dangling images
            docker system prune -f
            
            # Setup nginx configuration
            sudo tee /etc/nginx/sites-available/frappe-hrms > /dev/null << 'NGINX_CONFIG'
          server {
              listen 80;
              server_name _;
              
              client_max_body_size 50M;
              
              location / {
                  proxy_pass http://localhost:8000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 300s;
                  proxy_connect_timeout 75s;
              }
              
              location /socket.io {
                  proxy_pass http://localhost:9000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINX_CONFIG
            
            # Enable site and reload nginx
            sudo ln -sf /etc/nginx/sites-available/frappe-hrms /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "Deployment completed successfully!"
          ENDSSH

