name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: read

jobs:
  build-and-deploy:
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      DEPLOY_ARCHIVE: hrms-deploy.tar.gz
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fetch deployment secret
        id: aws-secret
        env:
          DEPLOY_SECRET_ID: ${{ secrets.AWS_DEPLOY_SECRET_ID }}
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_SECRET_ID:-}" ]; then
            echo "AWS_DEPLOY_SECRET_ID secret is missing"
            exit 1
          fi
          secret_json=$(aws secretsmanager get-secret-value --secret-id "$DEPLOY_SECRET_ID" --query 'SecretString' --output text)
          echo "::add-mask::$secret_json"
          {
            echo "secret-json<<'EOF'"
            echo "$secret_json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare deployment context
        id: context
        env:
          SECRET_JSON: ${{ steps.aws-secret.outputs.secret-json }}
        run: |
          set -euo pipefail
          python3 deploy/lightsail/prepare_context.py

      - name: Add Lightsail host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ steps.context.outputs.port }} ${{ steps.context.outputs.host }} >> ~/.ssh/known_hosts

      - name: Build containers
        run: docker compose -f docker/docker-compose.yml build

      - name: Package repository
        run: |
          tar --exclude=".git" --exclude=".github" -czf "$DEPLOY_ARCHIVE" .

      - name: Upload bundle to Lightsail
        run: |
          scp -i ${{ steps.context.outputs.ssh_key_path }} -P ${{ steps.context.outputs.port }} "$DEPLOY_ARCHIVE" "${{ steps.context.outputs.user }}@${{ steps.context.outputs.host }}:/tmp/$DEPLOY_ARCHIVE"

      - name: Deploy on Lightsail
        env:
          SSH_KEY_PATH: ${{ steps.context.outputs.ssh_key_path }}
          LIGHTSAIL_HOST: ${{ steps.context.outputs.host }}
          LIGHTSAIL_USER: ${{ steps.context.outputs.user }}
          LIGHTSAIL_PORT: ${{ steps.context.outputs.port }}
          REMOTE_PATH: ${{ steps.context.outputs.remote_path }}
          COMPOSE_FILE: ${{ steps.context.outputs.compose_file }}
          ENV_FILE: ${{ steps.context.outputs.env_file }}
          DEPLOY_ARCHIVE: ${{ env.DEPLOY_ARCHIVE }}
        run: |
          set -euo pipefail
          ssh -i "$SSH_KEY_PATH" -p "$LIGHTSAIL_PORT" "$LIGHTSAIL_USER@$LIGHTSAIL_HOST" "set -euo pipefail && mkdir -p '$REMOTE_PATH' && tar -xzf /tmp/$DEPLOY_ARCHIVE -C '$REMOTE_PATH' --strip-components=0 && cd '$REMOTE_PATH' && docker compose -f '$COMPOSE_FILE' --env-file '$ENV_FILE' up -d --build && docker system prune -f"

